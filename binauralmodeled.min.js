!function(a){if("object"==typeof exports)module.exports=a();else if("function"==typeof define&&define.amd)define(a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.createBinauralModeled=a()}}(function(){var a;return function b(a,c,d){function e(g,h){if(!c[g]){if(!a[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};a[g][0].call(j.exports,function(b){var c=a[g][1][b];return e(c?c:b)},j,j.exports,b,a,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){var c=a("kdt"),d=a("./libs/biquad-filter.js"),e=a("./libs/fractional-delay.js"),f=function(){"use strict";window.audioContext=window.audioContext||new AudioContext||new webkitAudioContext;var a={context:{writable:!0},hrtfDataset:{writable:!0},hrtfDatasetLength:{writable:!0},nextPosition:{writable:!0,value:[]},changeWhenFinishCrossfading:{writable:!0,value:!1},intervalID:{writable:!0},position:{writable:!0,value:[]},crossfadeDuration:{writable:!0,value:.02},bufferSize:{writable:!0,value:1024},sampleRate:{writable:!0},input:{writable:!0},tree:{writable:!0,value:-1},mainAudioGraph:{writable:!0},secondaryAudioGraph:{writable:!0},init:{enumerable:!0,value:function(){return this.input=audioContext.createGain(),this.mainAudioGraph=Object.create({},b),this.mainAudioGraph.init(),this.mainAudioGraph.gain.value=1,this.input.connect(this.mainAudioGraph.input),this.secondaryAudioGraph=Object.create({},b),this.secondaryAudioGraph.init(),this.secondaryAudioGraph.gain.value=0,this.input.connect(this.secondaryAudioGraph.input),this.sampleRate=audioContext.sampleRate,this.input.connect(this.mainAudioGraph.input),this.input.connect(this.secondaryAudioGraph.input),this}},connect:{enumerable:!0,value:function(a){return this.mainAudioGraph.connect(a),this.secondaryAudioGraph.connect(a),this}},disconnect:{enumerable:!0,value:function(a){return this.mainAudioGraph.disconnect(a),this.secondaryAudioGraph.disconnect(a),this}},HRTFDataset:{enumerable:!0,configurable:!0,set:function(a){this.hrtfDataset=a,this.hrtfDatasetLength=this.hrtfDataset.length;for(var b=0;b<this.hrtfDatasetLength;b++){var d=this.hrtfDataset[b],e=d.azimuth*Math.PI/180,f=d.elevation*Math.PI/180,g=this.sphericalToCartesian(e,f,d.distance);d.x=g.x,d.y=g.y,d.z=g.z}this.tree=c.createKdTree(this.hrtfDataset,this.distance,["x","y","z"]);var h=this.getHRTF(0,0,1);this.secondaryAudioGraph.setCoefficients(h.iir_coeffs_left,h.iir_coeffs_right),this.secondaryAudioGraph.setDelay(h.itd/1e3),this.mainAudioGraph.setCoefficients(h.iir_coeffs_left,h.iir_coeffs_right),this.mainAudioGraph.setDelay(h.itd/1e3)},get:function(){return this.hrtfDataset}},distance:{enumerable:!1,value:function(a,b){return Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2)+Math.pow(a.z-b.z,2)}},setLastPosition:{enumerable:!1,value:function(){this.isCrossfading()||(this.changeWhenFinishCrossfading=!1,clearInterval(this.intervalID),this.reallyStartPosition())}},crossfading:{enumerable:!1,value:function(){var a=audioContext.currentTime;this.mainAudioGraph.gain.setValueAtTime(1,a+2*this.bufferSize/this.sampleRate),this.mainAudioGraph.gain.linearRampToValueAtTime(0,a+this.crossfadeDuration+2*this.bufferSize/this.sampleRate),this.secondaryAudioGraph.gain.setValueAtTime(0,a+2*this.bufferSize/this.sampleRate),this.secondaryAudioGraph.gain.linearRampToValueAtTime(1,a+this.crossfadeDuration+2*this.bufferSize/this.sampleRate)}},setPosition:{enumerable:!0,value:function(a,b,c){if(3===arguments.length){var d=this.getRealCoordinates(a,b,c);if(d.azimuth!==this.position.azimuth||d.elevation!==this.position.elevation||d.distance!==this.position.distance)return this.isCrossfading()===!0?(this.changeWhenFinishCrossfading===!0?clearInterval(this.intervalID):this.changeWhenFinishCrossfading=!0,this.nextPosition.azimuth=d.azimuth,this.nextPosition.elevation=d.elevation,this.nextPosition.distance=d.distance,this.intervalID=window.setInterval(this.setLastPosition.bind(this),.005)):(this.nextPosition.azimuth=d.azimuth,this.nextPosition.elevation=d.elevation,this.nextPosition.distance=d.distance,this.reallyStartPosition()),this}}},reallyStartPosition:{enumerable:!1,value:function(){this.position.azimuth=this.nextPosition.azimuth,this.position.elevation=this.nextPosition.elevation,this.position.distance=this.nextPosition.distance;var a=this.getHRTF(this.position.azimuth,this.position.elevation,this.position.distance);this.secondaryAudioGraph.setCoefficients(a.iir_coeffs_left,a.iir_coeffs_right),this.secondaryAudioGraph.setDelay(a.itd/1e3),this.crossfading();var b=this.mainAudioGraph;this.mainAudioGraph=this.secondaryAudioGraph,this.secondaryAudioGraph=b}},getPosition:{enumerable:!0,value:function(){return this.position}},setCrossfadeDuration:{enumerable:!0,value:function(a){this.crossfadeDuration=a/1e3}},getCrossfadeDuration:{enumerable:!0,value:function(){return 1e3*crossfadeDuration}},isCrossfading:{enumerable:!0,value:function(){return 1!==this.mainAudioGraph.gain.value?!0:!1}},getHRTF:{enumerable:!1,value:function(a,b,c){var d=this.getNearestPoint(a,b,c),e=[];return e.iir_coeffs_left=d.iir_coeffs_left,e.iir_coeffs_right=d.iir_coeffs_right,e.itd=d.itd,e}},sphericalToCartesian:{enumerable:!1,value:function(a,b,c){return{x:c*Math.sin(a),y:c*Math.cos(a),z:c*Math.sin(b)}}},getRealCoordinates:{enumerable:!1,value:function(a,b,c){var d=this.getNearestPoint(a,b,c);return{azimuth:d.azimuth,elevation:d.elevation,distance:d.distance}}},getNearestPoint:{enumerable:!1,value:function(a,b,c){var d=a*Math.PI/180,e=b*Math.PI/180,f=this.sphericalToCartesian(d,e,c),g=this.tree.nearest(f,1)[0];return g[0]}}},b={biquadFilterLeft:{writable:!0},biquadFilterRight:{writable:!0},fractionalDelayLeft:{writable:!0},fractionalDelayRight:{writable:!0},gainNode:{writable:!0},input:{writable:!0},processorNode:{writable:!0},bufferSize:{writable:!0,value:1024},init:{enumerable:!0,value:function(){return this.input=audioContext.createGain(),this.gainNode=audioContext.createGain(),this.biquadFilterLeft=d(),this.biquadFilterRight=d(),this.fractionalDelayLeft=e(44100),this.fractionalDelayRight=e(44100),this.processorNode=audioContext.createScriptProcessor(this.bufferSize),this.input.connect(this.processorNode),this.processorNode.connect(this.gainNode),this.processorNodeFunction(),this}},gain:{enumerable:!0,get:function(){return this.gainNode.gain}},setCoefficients:{enumerable:!1,value:function(a,b){this.biquadFilterLeft.setCoefficients(a),this.biquadFilterRight.setCoefficients(b)}},setDelay:{enumerable:!1,value:function(a){var b=.001+a/2,c=.001-a/2;this.fractionalDelayLeft.setDelay(b),this.fractionalDelayRight.setDelay(c)}},processorNodeFunction:{enumerable:!1,configurable:!0,value:function(){var a=this;this.processorNode.onaudioprocess=function(b){var c=b.inputBuffer.getChannelData(0),d=b.outputBuffer.getChannelData(0),e=b.outputBuffer.getChannelData(1),f=new Float32Array(a.fractionalDelayLeft.process(c)),g=new Float32Array(a.fractionalDelayRight.process(c));a.biquadFilterLeft.process(f,d),a.biquadFilterRight.process(g,e)}}},connect:{enumerable:!0,value:function(a){return this.gainNode.connect(a),this}},disconnect:{enumerable:!0,value:function(a){return this.gainNode.disconnect(a),this}}},f=Object.create({},a);return f.init()};b.exports=f},{"./libs/biquad-filter.js":2,"./libs/fractional-delay.js":3,kdt:4}],2:[function(b,c,d){(function(e){!function(b){if("object"==typeof d)c.exports=b();else if("function"==typeof a&&a.amd)a(b);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof e?f=e:"undefined"!=typeof self&&(f=self),f.createBiquadFilter=b()}}(function(){return function a(c,d,e){function f(h,i){if(!d[h]){if(!c[h]){var j="function"==typeof b&&b;if(!i&&j)return j(h,!0);if(g)return g(h,!0);throw new Error("Cannot find module '"+h+"'")}var k=d[h]={exports:{}};c[h][0].call(k.exports,function(a){var b=c[h][1][a];return f(b?b:a)},k,k.exports,a,c,d,e)}return d[h].exports}for(var g="function"==typeof b&&b,h=0;h<e.length;h++)f(e[h]);return f}({1:[function(a,b){var c=function(){"use strict";var a={coefficients:{writable:!0,value:[]},memories:{writable:!0,value:[]},numberOfCascade:{writable:!0,value:1},context:{writable:!0},init:{enumerable:!0,value:function(){return this.resetMemories(),this}},setCoefficients:{enumerable:!0,value:function(a){if(a){this.numberOfCascade=this.getNumberOfCascadeFilters(a),this.coefficients=[],this.coefficients.g=a[0];for(var b=0;b<this.numberOfCascade;b+=1)this.coefficients[b]={},this.coefficients[b].b1=a[1+4*b],this.coefficients[b].b2=a[2+4*b],this.coefficients[b].a1=a[3+4*b],this.coefficients[b].a2=a[4+4*b];return this.resetMemories(),!0}return console.error("No coefficients are set"),!1}},getNumberOfCascadeFilters:{enumerable:!1,value:function(a){var b=(a.length-1)/4;return b}},resetMemories:{enumerable:!0,value:function(){this.memories=[],this.memories[0]={},this.memories[0].xi1=0,this.memories[0].xi2=0,this.memories[0].yi1=0,this.memories[0].yi2=0;for(var a=1;a<this.numberOfCascade;a+=1)this.memories[a]={},this.memories[a].yi1=0,this.memories[a].yi2=0}},process:{enumerable:!0,value:function(a,b){for(var c,d,e,f,g,h,i,j,k,l,m,n=[],o=0;o<a.length;o+=1){c=a[o],d=this.coefficients[0].b1,e=this.coefficients[0].b2,f=this.coefficients[0].a1,g=this.coefficients[0].a2,h=this.memories[0].xi1,i=this.memories[0].xi2,j=this.memories[0].yi1,k=this.memories[0].yi2,n[0]=c+d*h+e*i-f*j-g*k;for(var p=1;p<this.numberOfCascade;p+=1)d=this.coefficients[p].b1,e=this.coefficients[p].b2,f=this.coefficients[p].a1,g=this.coefficients[p].a2,l=this.memories[p-1].yi1,m=this.memories[p-1].yi2,j=this.memories[p].yi1,k=this.memories[p].yi2,n[p]=n[p-1]+d*l+e*m-f*j-g*k;b[o]=n[this.numberOfCascade-1]*this.coefficients.g,this.memories[0].xi2=this.memories[0].xi1,this.memories[0].xi1=c;for(var q=0;q<this.numberOfCascade;q+=1)this.memories[q].yi2=this.memories[q].yi1,this.memories[q].yi1=n[q]}}}},b=Object.create({},a);return b.init()};b.exports=c},{}]},{},[1])(1)})}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],3:[function(b,c,d){(function(e){!function(b){if("object"==typeof d)c.exports=b();else if("function"==typeof a&&a.amd)a(b);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof e?f=e:"undefined"!=typeof self&&(f=self),f.createFractionalDelay=b()}}(function(){return function a(c,d,e){function f(h,i){if(!d[h]){if(!c[h]){var j="function"==typeof b&&b;if(!i&&j)return j(h,!0);if(g)return g(h,!0);throw new Error("Cannot find module '"+h+"'")}var k=d[h]={exports:{}};c[h][0].call(k.exports,function(a){var b=c[h][1][a];return f(b?b:a)},k,k.exports,a,c,d,e)}return d[h].exports}for(var g="function"==typeof b&&b,h=0;h<e.length;h++)f(e[h]);return f}({1:[function(a,b){var c=function(a,b){"use strict";var c={delayTime:{writable:!0,value:0},maxDelayTime:{writable:!0,value:1},posRead:{writable:!0,value:0},posWrite:{writable:!0,value:0},fracXi1:{writable:!0,value:0},fracXi2:{writable:!0,value:0},fracYi1:{writable:!0,value:0},intDelay:{writable:!0,value:0},fracDelay:{writable:!0,value:0},sampleRate:{writable:!0},buffer:{writable:!0},bufferSize:{writable:!0},a1:{writable:!0},init:{enumerable:!0,value:function(a,b){return this.sampleRate=a,this.maxDelayTime=b||this.maxDelayTime,this.bufferSize=this.maxDelayTime*this.sampleRate,this.bufferSize%1!==0&&(this.bufferSize=parseInt(this.bufferSize)+1),this.buffer=new Float32Array(this.bufferSize),this}},setDelay:{enumerable:!0,value:function(a){if(a<this.maxDelayTime){this.delayTime=a;var b=a*this.sampleRate;this.intDelay=parseInt(b),this.fracDelay=b-this.intDelay,this.resample(),0!==this.fracDelay&&this.updateThiranCoefficient()}else console.log("throw error...how?")}},getDelay:{enumerable:!0,value:function(){return this.delayTime}},process:{enumerable:!0,value:function(a){for(var b=new Float32Array(a.length),c=0;c<a.length;c+=1)this.buffer[this.posWrite]=a[c],b[c]=this.buffer[this.posRead],this.updatePointers();return 0===this.fracDelay?b:b=new Float32Array(this.fractionalThiranProcess(b))}},updatePointers:{enumerable:!1,value:function(){this.posWrite=this.posWrite===this.buffer.length-1?0:this.posWrite+1,this.posRead=this.posRead===this.buffer.length-1?0:this.posRead+1}},updateThiranCoefficient:{enumerable:!1,value:function(){this.a1=(1-this.fracDelay)/(1+this.fracDelay)}},resample:{enumerable:!1,value:function(){if(this.posWrite-this.intDelay<0){var a=this.intDelay-this.posWrite;this.posRead=this.buffer.length-a}else this.posRead=this.posWrite-this.intDelay}},fractionalThiranProcess:{enumerable:!1,value:function(a){for(var b,c,d=new Float32Array(a.length),e=this.fracXi1,f=this.fracXi2,g=this.fracYi1,h=0;h<a.length;h+=1)b=a[h],c=this.a1*b+e-this.a1*g,e=b,g=c,d[h]=c;return this.fracXi1=e,this.fracXi2=f,this.fracYi1=g,d}}},d=Object.create({},c);return d.init(a,b)};b.exports=c},{}]},{},[1])(1)})}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],4:[function(a,b){function c(a,b,c){this.obj=a,this.left=null,this.right=null,this.parent=c,this.dimension=b}function d(a,b,d){function f(a,b,e){var g,h,i=b%d.length;return 0===a.length?null:1===a.length?new c(a[0],i,e):(a.sort(function(a,b){return a[d[i]]-b[d[i]]}),g=Math.floor(a.length/2),h=new c(a[g],i,e),h.left=f(a.slice(0,g),b+1,h),h.right=f(a.slice(g+1),b+1,h),h)}var g=this;this.root=f(a,0,null),this.insert=function(a){function b(c,e){if(null===c)return e;var f=d[c.dimension];return a[f]<c.obj[f]?b(c.left,c):b(c.right,c)}var e,f,g=b(this.root,null);return null===g?void(this.root=new c(a,0,null)):(e=new c(a,(g.dimension+1)%d.length,g),f=d[g.dimension],void(a[f]<g.obj[f]?g.left=e:g.right=e))},this.remove=function(a){function b(c){if(null===c)return null;if(c.obj===a)return c;var e=d[c.dimension];return a[e]<c.obj[e]?b(c.left,c):b(c.right,c)}function c(a){function b(a,c){var e,f,g,h,i;return null===a?null:(e=d[c],a.dimension===c?null!==a.right?b(a.right,c):a:(f=a.obj[e],g=b(a.left,c),h=b(a.right,c),i=a,null!==g&&g.obj[e]>f&&(i=g),null!==h&&h.obj[e]>i.obj[e]&&(i=h),i))}function e(a,b){var c,f,g,h,i;return null===a?null:(c=d[b],a.dimension===b?null!==a.left?e(a.left,b):a:(f=a.obj[c],g=e(a.left,b),h=e(a.right,b),i=a,null!==g&&g.obj[c]<f&&(i=g),null!==h&&h.obj[c]<i.obj[c]&&(i=h),i))}var f,h,i;return null===a.left&&null===a.right?null===a.parent?void(g.root=null):(i=d[a.parent.dimension],void(a.obj[i]<a.parent.obj[i]?a.parent.left=null:a.parent.right=null)):(f=null!==a.left?b(a.left,a.dimension):e(a.right,a.dimension),h=f.obj,c(f),void(a.obj=h))}var e;e=b(g.root),null!==e&&c(e)},this.nearest=function(a,c,f){function h(e){function f(a,b){k.push([a,b]),k.size()>c&&k.pop()}var g,i,j,l,m=d[e.dimension],n=b(a,e.obj),o={};for(l=0;l<d.length;l+=1)o[d[l]]=l===e.dimension?a[d[l]]:e.obj[d[l]];return i=b(o,e.obj),null===e.right&&null===e.left?void((k.size()<c||n<k.peek()[1])&&f(e,n)):(g=null===e.right?e.left:null===e.left?e.right:a[m]<e.obj[m]?e.left:e.right,h(g),(k.size()<c||n<k.peek()[1])&&f(e,n),void((k.size()<c||Math.abs(i)<k.peek()[1])&&(j=g===e.left?e.right:e.left,null!==j&&h(j))))}var i,j,k;if(k=new e(function(a){return-a[1]}),f)for(i=0;c>i;i+=1)k.push([null,f]);for(h(g.root),j=[],i=0;c>i;i+=1)k.content[i][0]&&j.push([k.content[i][0].obj,k.content[i][1]]);return j},this.balanceFactor=function(){function a(b){return null===b?0:Math.max(a(b.left),a(b.right))+1}function b(a){return null===a?0:b(a.left)+b(a.right)+1}return a(g.root)/(Math.log(b(g.root))/Math.log(2))}}function e(a){this.content=[],this.scoreFunction=a}e.prototype={push:function(a){this.content.push(a),this.bubbleUp(this.content.length-1)},pop:function(){var a=this.content[0],b=this.content.pop();return this.content.length>0&&(this.content[0]=b,this.sinkDown(0)),a},peek:function(){return this.content[0]},remove:function(a){for(var b=this.content.length,c=0;b>c;c++)if(this.content[c]==a){var d=this.content.pop();return void(c!=b-1&&(this.content[c]=d,this.scoreFunction(d)<this.scoreFunction(a)?this.bubbleUp(c):this.sinkDown(c)))}throw new Error("Node not found.")},size:function(){return this.content.length},bubbleUp:function(a){for(var b=this.content[a];a>0;){var c=Math.floor((a+1)/2)-1,d=this.content[c];if(!(this.scoreFunction(b)<this.scoreFunction(d)))break;this.content[c]=b,this.content[a]=d,a=c}},sinkDown:function(a){for(var b=this.content.length,c=this.content[a],d=this.scoreFunction(c);;){var e=2*(a+1),f=e-1,g=null;if(b>f){var h=this.content[f],i=this.scoreFunction(h);d>i&&(g=f)}if(b>e){var j=this.content[e],k=this.scoreFunction(j);(null==g?d:i)>k&&(g=e)}if(null==g)break;this.content[a]=this.content[g],this.content[g]=c,a=g}}},b.exports={createKdTree:function(a,b,c){return new d(a,b,c)}}},{}]},{},[1])(1)});